name: Manual Rollback

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        type: choice
        options:
          - frontend
          - backend
          - both
      confirm:
        description: 'Type "ROLLBACK" to confirm'
        required: true
        type: string

# Required for OIDC authentication
permissions:
  id-token: write
  contents: read

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Validate confirmation
        if: ${{ github.event.inputs.confirm != 'ROLLBACK' }}
        run: |
          echo "âŒ Rollback not confirmed. Please type 'ROLLBACK' to confirm."
          exit 1

  rollback-frontend:
    needs: validate
    if: ${{ github.event.inputs.target == 'frontend' || github.event.inputs.target == 'both' }}
    runs-on: ubuntu-latest
    environment: production
    
    steps:

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Rollback frontend
        run: |
          echo "ðŸ”„ Rolling back frontend..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.FRONTEND_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "LATEST_BACKUP=$(ls -td /var/www/html.backup.* 2>/dev/null | head -1)",
              "if [ -n \"$LATEST_BACKUP\" ]; then",
              "  echo Found backup: $LATEST_BACKUP",
              "  sudo rm -rf /var/www/html/*",
              "  sudo cp -r $LATEST_BACKUP/* /var/www/html/",
              "  sudo systemctl reload nginx 2>/dev/null || sudo systemctl reload apache2",
              "  echo Rollback completed successfully",
              "else",
              "  echo No backup found!",
              "  exit 1",
              "fi"
            ]' \
            --query 'Command.CommandId' --output text)
          
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.FRONTEND_INSTANCE_ID }}
          echo "âœ… Frontend rollback completed"

  rollback-backend:
    needs: validate
    if: ${{ github.event.inputs.target == 'backend' || github.event.inputs.target == 'both' }}
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Rollback backend
        run: |
          echo "ðŸ”„ Rolling back backend..."
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.BACKEND_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "LATEST_BACKUP=$(ls -td ~/app.backup.* 2>/dev/null | head -1)",
              "if [ -n \"$LATEST_BACKUP\" ]; then",
              "  echo Found backup: $LATEST_BACKUP",
              "  rm -rf ~/app",
              "  cp -r $LATEST_BACKUP ~/app",
              "  cd ~/app && npm ci --production",
              "  pm2 restart backendAPI",
              "  echo Rollback completed successfully",
              "else",
              "  echo No backup found!",
              "  exit 1",
              "fi"
            ]' \
            --query 'Command.CommandId' --output text)
          
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.BACKEND_INSTANCE_ID }}
          echo "âœ… Backend rollback completed"
